{"title":"代码备份","date":"2020-07-20T07:05:18.552Z","date_formatted":{"ll":"Jul 20, 2020","L":"07/20/2020","MM-DD":"07-20"},"link":"2020/07/20/代码备份","tags":["源码"],"categories":["编程技术"],"updated":"2020-07-20T07:05:18.553Z","content":"<p>实现的需求整理备份</p>\n<a id=\"more\"></a>\n<h3 id=\"一.上传文件创建需求\">一.上传文件创建需求<a title=\"#一.上传文件创建需求\" href=\"#一.上传文件创建需求\"></a></h3>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">'use strict'</span>;</span><br><span class=\"line\"><span class=\"keyword\">const</span> Service = <span class=\"built_in\">require</span>(<span class=\"string\">'egg'</span>).Service;</span><br><span class=\"line\"><span class=\"comment\">// 文件模块</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> _ = <span class=\"built_in\">require</span>(<span class=\"string\">'lodash'</span>);</span><br><span class=\"line\"><span class=\"keyword\">let</span> stories = [];</span><br><span class=\"line\"><span class=\"keyword\">const</span> _recursionHtml = <span class=\"function\">(<span class=\"params\">notes, parentName</span>) =&gt;</span> &#123;</span><br><span class=\"line\">  notes.map(<span class=\"function\"><span class=\"params\">e</span> =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (e.pageName) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">const</span> name = parentName + e.pageName;</span><br><span class=\"line\">      stories.push(name);</span><br><span class=\"line\">      <span class=\"comment\">// 递归子节点</span></span><br><span class=\"line\">      <span class=\"keyword\">if</span> (e.children) &#123;</span><br><span class=\"line\">        _recursionHtml(e.children, name + <span class=\"string\">'/'</span>);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">StoryService</span> <span class=\"keyword\">extends</span> <span class=\"title\">Service</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">async</span> addStoryByFile() &#123;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> &#123; ctx, app &#125; = <span class=\"keyword\">this</span>;</span><br><span class=\"line\">    <span class=\"comment\">// 参数接收,校验</span></span><br><span class=\"line\">    <span class=\"keyword\">let</span> stream = <span class=\"string\">''</span>;</span><br><span class=\"line\">    <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">      stream = <span class=\"keyword\">await</span> ctx.getFileStream();</span><br><span class=\"line\">    &#125; <span class=\"keyword\">catch</span> (err) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">return</span> err;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> session = ctx.session;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> workspace_id = stream.fields.workspace_id;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> iteration_id = stream.fields.iteration_id;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!stream || !workspace_id || !iteration_id) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"built_in\">Error</span>(<span class=\"string\">'params error'</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"comment\">// 时间锁</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (session.cTime) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">const</span> sIteration_id = session.sIteration_id || <span class=\"string\">''</span>;</span><br><span class=\"line\">      <span class=\"keyword\">const</span> isBlocker = (<span class=\"built_in\">Date</span>.now() - session.cTime) &lt; <span class=\"number\">7000</span>;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (isBlocker &amp;&amp; sIteration_id === iteration_id) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> &#123;&#125;;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    ctx.session.cTime = <span class=\"built_in\">Date</span>.now();</span><br><span class=\"line\">    ctx.session.sIteration_id = iteration_id;</span><br><span class=\"line\">    <span class=\"comment\">// 读取文件代码</span></span><br><span class=\"line\">    stream.setEncoding(<span class=\"string\">'utf-8'</span>);</span><br><span class=\"line\">    <span class=\"keyword\">let</span> data = <span class=\"string\">''</span>;</span><br><span class=\"line\">    stream.on(<span class=\"string\">'data'</span>, chunk =&gt; &#123;</span><br><span class=\"line\">      data += chunk;</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">    <span class=\"keyword\">await</span> <span class=\"keyword\">new</span> <span class=\"built_in\">Promise</span>(<span class=\"function\">(<span class=\"params\">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class=\"line\">      stream.on(<span class=\"string\">'end'</span>, () =&gt; &#123; <span class=\"comment\">// 监听状态</span></span><br><span class=\"line\">        resolve();</span><br><span class=\"line\">      &#125;);</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">    <span class=\"comment\">// 执行代码方法</span></span><br><span class=\"line\">    <span class=\"keyword\">const</span> $axure = &#123;&#125;;</span><br><span class=\"line\">    <span class=\"keyword\">let</span> rootNodes = &#123;&#125;;</span><br><span class=\"line\">    $axure.loadDocument = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">d</span>) </span>&#123;</span><br><span class=\"line\">      rootNodes = d.sitemap.rootNodes || <span class=\"string\">''</span>;</span><br><span class=\"line\">    &#125;;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!data.match(<span class=\"regexp\">/axure.loadDocument/</span>)) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"built_in\">Error</span>(<span class=\"string\">'con\\'t analysis file'</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">      <span class=\"built_in\">eval</span>(data);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">catch</span> (err) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">return</span> err;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (rootNodes.length === <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"built_in\">Error</span>(<span class=\"string\">'analysis file error'</span>);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (rootNodes.length === <span class=\"number\">1</span>) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (rootNodes[<span class=\"number\">0</span>].children) &#123;</span><br><span class=\"line\">        _recursionHtml(rootNodes[<span class=\"number\">0</span>].children, <span class=\"string\">''</span>);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">      _recursionHtml(rootNodes, <span class=\"string\">''</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"comment\">// 获取当前要创建的迭代的需求</span></span><br><span class=\"line\">    <span class=\"keyword\">const</span> curStories = <span class=\"keyword\">await</span> app.tapd(<span class=\"string\">'stories'</span>, &#123;</span><br><span class=\"line\">      data: &#123; workspace_id, iteration_id, <span class=\"attr\">limit</span>: <span class=\"number\">200</span> &#125;,</span><br><span class=\"line\">      method: <span class=\"string\">'GET'</span>,</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">    <span class=\"comment\">// 如果当前迭代已有需求，去重</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (curStories.status === <span class=\"number\">1</span> &amp;&amp; curStories.data.lenght !== <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">const</span> curNames = [];</span><br><span class=\"line\">      curStories.data.map(<span class=\"function\"><span class=\"params\">e</span> =&gt;</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">const</span> name = e.Story.name || <span class=\"string\">''</span>;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (curNames.indexOf(name) === <span class=\"number\">-1</span>) &#123;</span><br><span class=\"line\">          curNames.push(name);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;);</span><br><span class=\"line\">      stories = _.difference(stories, curNames);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"comment\">// 创建需求和任务</span></span><br><span class=\"line\">    <span class=\"keyword\">const</span> creator = ctx.session.user.real_name || <span class=\"string\">''</span>;</span><br><span class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"keyword\">const</span> name <span class=\"keyword\">of</span> stories) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">const</span> result = <span class=\"keyword\">await</span> app.tapd(<span class=\"string\">'stories'</span>, &#123;</span><br><span class=\"line\">        data: &#123; name, workspace_id, iteration_id, <span class=\"attr\">priority</span>: <span class=\"number\">3</span>, creator &#125;,</span><br><span class=\"line\">        method: <span class=\"string\">'POST'</span>,</span><br><span class=\"line\">      &#125;);</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (result.status === <span class=\"number\">1</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">const</span> story_id = result.data.Story.id;</span><br><span class=\"line\">        <span class=\"keyword\">const</span> qName = name + <span class=\"string\">'_前端'</span>;</span><br><span class=\"line\">        <span class=\"keyword\">const</span> taskRes = <span class=\"keyword\">await</span> app.tapd(<span class=\"string\">'tasks'</span>, &#123;</span><br><span class=\"line\">          data: &#123; <span class=\"attr\">name</span>: qName, workspace_id, iteration_id, <span class=\"attr\">priority</span>: <span class=\"number\">3</span>, creator, story_id &#125;,</span><br><span class=\"line\">          method: <span class=\"string\">'POST'</span>,</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> &#123;&#125;;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"built_in\">module</span>.exports = StoryService;</span><br></pre></td></tr></table></figure>\n<h3 id=\"二.导出excel浏览器下载\">二.导出excel浏览器下载<a title=\"#二.导出excel浏览器下载\" href=\"#二.导出excel浏览器下载\"></a></h3>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> xlsx = <span class=\"built_in\">require</span>(<span class=\"string\">'node-xlsx'</span>);</span><br><span class=\"line\"><span class=\"keyword\">const</span> moment = <span class=\"built_in\">require</span>(<span class=\"string\">'moment'</span>);</span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 导出文章统计数据为xlsx文件</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@param <span class=\"type\">&#123;*&#125;</span> </span>ctx </span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">async</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">exportResource</span>(<span class=\"params\">ctx</span>)</span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">const</span> req = ctx.request;</span><br><span class=\"line\">  <span class=\"keyword\">const</span> result = <span class=\"keyword\">await</span> _getEliteResources(req);<span class=\"comment\">// 获取数据,无关方法略</span></span><br><span class=\"line\">  <span class=\"keyword\">let</span> rows = result.rows || [];                <span class=\"comment\">// 获取数据数组</span></span><br><span class=\"line\">  <span class=\"comment\">// 创建excel二维数组，定义表头</span></span><br><span class=\"line\">  <span class=\"keyword\">let</span> retval = [</span><br><span class=\"line\">    [<span class=\"string\">'文章名称'</span>, <span class=\"string\">'创建者'</span>, <span class=\"string\">'审核者'</span>, <span class=\"string\">'创建时间'</span>,<span class=\"string\">'浏览'</span>,<span class=\"string\">'收藏'</span>,<span class=\"string\">'点赞'</span>,<span class=\"string\">'点击量'</span>,<span class=\"string\">'点击率'</span>,<span class=\"string\">'转发次数'</span>]</span><br><span class=\"line\">  ]; </span><br><span class=\"line\">  <span class=\"comment\">// 添加订单数据</span></span><br><span class=\"line\">  <span class=\"keyword\">for</span> (<span class=\"keyword\">let</span> row <span class=\"keyword\">of</span> rows || []) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">const</span> statistics = row.statistics;</span><br><span class=\"line\">      retval.push([</span><br><span class=\"line\">          row.body.title || <span class=\"string\">''</span>,</span><br><span class=\"line\">          row.creator || <span class=\"string\">''</span>,</span><br><span class=\"line\">          row.last_editor,</span><br><span class=\"line\">          row.ctime,</span><br><span class=\"line\">          statistics.show_count,</span><br><span class=\"line\">          statistics.collection_count,</span><br><span class=\"line\">          statistics.like_count,</span><br><span class=\"line\">          statistics.click_count,</span><br><span class=\"line\">          statistics.view_rate,</span><br><span class=\"line\">          statistics.forward_count,</span><br><span class=\"line\">      ]);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"comment\">// 空数据时填充</span></span><br><span class=\"line\">  retval.push([ <span class=\"string\">''</span>, <span class=\"string\">''</span>, <span class=\"string\">''</span>, <span class=\"string\">''</span>, <span class=\"string\">''</span>, <span class=\"string\">''</span>, <span class=\"string\">''</span>, <span class=\"string\">''</span>, <span class=\"string\">''</span>, <span class=\"string\">''</span>]);</span><br><span class=\"line\">  <span class=\"comment\">// 创建数据流</span></span><br><span class=\"line\">  <span class=\"keyword\">let</span> buffer = xlsx.build([&#123;</span><br><span class=\"line\">      data: retval</span><br><span class=\"line\">  &#125;]);</span><br><span class=\"line\">  <span class=\"comment\">// 设置生成的文件名</span></span><br><span class=\"line\">  <span class=\"keyword\">let</span> filename = moment(<span class=\"keyword\">new</span> <span class=\"built_in\">Date</span>()).format(<span class=\"string\">'YYYY-MM-DD'</span>) + <span class=\"string\">'文件名'</span>;</span><br><span class=\"line\">  filename = <span class=\"built_in\">encodeURIComponent</span>(filename);</span><br><span class=\"line\">  <span class=\"keyword\">let</span> disposition = <span class=\"string\">`attachment;filename=<span class=\"subst\">$&#123;filename&#125;</span>.xlsx`</span>;</span><br><span class=\"line\">  <span class=\"comment\">// 设置响应头</span></span><br><span class=\"line\">  ctx.response.set(&#123;</span><br><span class=\"line\">      <span class=\"string\">'content-type'</span>: <span class=\"string\">'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'</span>,</span><br><span class=\"line\">      <span class=\"string\">'content-disposition'</span>: disposition,</span><br><span class=\"line\">      <span class=\"string\">'filename'</span>: filename + <span class=\"string\">'.xlsx'</span></span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">  ctx.body = buffer;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"三.使用axios下载网络资源\">三.使用axios下载网络资源<a title=\"#三.使用axios下载网络资源\" href=\"#三.使用axios下载网络资源\"></a></h3>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">const axios &#x3D; require(&#39;axios&#39;);</span><br><span class=\"line\">const GET_RESOURCES_URL &#x3D; &#39;http:&#x2F;&#x2F;127.0.0.1:8160&#x2F;fdp_api&#x2F;resources&#39;;</span><br><span class=\"line\">const PUT_RESOURCE_URL &#x3D; &#39;http:&#x2F;&#x2F;127.0.0.1:8160&#x2F;fdp_api&#x2F;resources&#x2F;cover&#39;;</span><br><span class=\"line\">const Cookie &#x3D; &#39;kbplat-test-session-id&#x3D;6719da848e0ec864081ea55f28ff77ab197f90829085338f8d5b7871aeae4f974a7b7406c388bc58b9973528d17ea0c1259af9cb32b925a944774bd4d2235fa069af99c24f35ee09e2267f21387028df580b434864df19f10d333afac3dec2bb060fa0666ed539ca2203fac9adcee9bef20dccfb6fb16e0d104fd1a5fa828702cc9d0d1f98f16b0c249bc72bc8c4933e81064a6b57de0fe9fd1075fa7d239e8d140fa093f11ecdd0775e6e07a212a5811bca6a3fee90070bd9d56b38c4aa747d733c80571999188a448e0d6a86af8d9db5c9e172e353b43465d47d05dbfc927e32ef46c812b0feb503db58e4dbf5c2feb497f27f6b2cbba755ccb21b25d258bc39089cb7c358df368e8c2db00cff57cdc72b30c94316a4a69ebeb27f9871394835584b168ed55b41bcc7c6a85518cfba0a9a7435979e88dac0ad3d93b32af50412efcd6483adb7ccbfad0c3e4b2cdea809a070d91454aef7e4d2ea295d646ddd475ce1f6580d0ade71271308882ae2daf57a1b9603e4a640131b524f28017e6e5ef38b9c15ea4ef185b91865c645a4333d50090a36c38a6d589bf3ab70779aee6787b1ea97a4ccc537b2bb3f327ceb8d6ad7d35fc435fe680c3c8aba087b90e0&#39;;</span><br><span class=\"line\"></span><br><span class=\"line\">(async function updateCovers()&#123;</span><br><span class=\"line\">  let resources &#x3D; [];</span><br><span class=\"line\">  await new Promise((resolve, reject) &#x3D;&gt; &#123;</span><br><span class=\"line\">    axios(&#123; </span><br><span class=\"line\">      headers: &#123; &#39;Cookie&#39;: Cookie &#125;,</span><br><span class=\"line\">      method: &#39;get&#39;, </span><br><span class=\"line\">      url: GET_RESOURCES_URL, </span><br><span class=\"line\">      params: &#123; elite: 1, type: &#39;视频&#39;, limit: 760&#125;</span><br><span class=\"line\">    &#125;).then(response &#x3D;&gt; &#123;</span><br><span class=\"line\">      resources &#x3D; response.data.data.rows;</span><br><span class=\"line\">      resolve();</span><br><span class=\"line\">    &#125;).catch(err &#x3D;&gt; &#123;</span><br><span class=\"line\">      throw err;</span><br><span class=\"line\">      reject();</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">  for(let i &#x3D; 7; i &lt; 8; i++)&#123;</span><br><span class=\"line\">    const response &#x3D; await axios(&#123; </span><br><span class=\"line\">      method: &#39;put&#39;, </span><br><span class=\"line\">      headers: &#123; &#39;Cookie&#39;: Cookie &#125;,</span><br><span class=\"line\">      url: PUT_RESOURCE_URL, </span><br><span class=\"line\">      data: resources[i]</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;)();</span><br></pre></td></tr></table></figure>","prev":{"title":"上传文件到金山云","link":"2020/07/20/上传文件到金山云"},"next":{"title":"wuti1","link":"2020/07/20/wuti1"},"plink":"http://qiuxiaori.github.com/2020/07/20/代码备份/","toc":[{"id":"一.上传文件创建需求","title":"一.上传文件创建需求","index":"1"},{"id":"二.导出excel浏览器下载","title":"二.导出excel浏览器下载","index":"2"},{"id":"三.使用axios下载网络资源","title":"三.使用axios下载网络资源","index":"3"}],"copyright":{"author":"Qiu Xiaori","license":"自由转载-非商用-禁止演绎-保持署名（CC BY-NC-ND 4.0)","link":"<a href=\"http://qiuxiaori.github.com/2020/07/20/代码备份/\" title=\"代码备份\">http://qiuxiaori.github.com/2020/07/20/代码备份/</a>"}}
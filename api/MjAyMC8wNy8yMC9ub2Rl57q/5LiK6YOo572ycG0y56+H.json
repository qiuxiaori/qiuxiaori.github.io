{"title":"node线上部署pm2篇","date":"2020-07-20T07:05:18.550Z","date_formatted":{"ll":"Jul 20, 2020","L":"07/20/2020","MM-DD":"07-20"},"link":"2020/07/20/node线上部署pm2篇","tags":["pm2"],"categories":["编程技术"],"updated":"2020-07-20T07:05:18.550Z","content":"<blockquote>\n<p><a href=\"http://pm2.keymetrics.io/docs/usage/quick-start/#42-starts\" target=\"_blank\">PM2</a>是守护进程管理器，可帮助您管理和保持应用程序在线。PM2入门很简单，它是一个简单直观的CLI，可通过NPM安装。</p>\n</blockquote>\n<a id=\"more\"></a>\n<h3 id=\"一.安装使用\">一.安装使用<a title=\"#一.安装使用\" href=\"#一.安装使用\"></a></h3>\n<ol>\n<li>安装<br>\n可以通过npm或yarn方式安装最新版pm2```js<br>\nnpm install pm2@latest -g</li>\n</ol>\n<h1 id=\"or\">or<a title=\"#or\" href=\"#or\"></a></h1>\n<p>yarn global add pm2</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">2. 启动项目</span><br><span class=\"line\">&#96;pm2 start [app.js]     # 项目入口文件&#96;</span><br><span class=\"line\"></span><br><span class=\"line\">* 可以传给cli一些配置来指定启动项</span><br></pre></td></tr></table></figure>\n<p>–name &lt;app_name&gt;   // 指定启动的服务名称<br>\n–watch             // 监控项目变化，文件变更时自动重启，一般线上环境不监控<br>\n–max-memory-restart &lt;200MB&gt;  // 内存达到后重启服务<br>\n–log &lt;log_path&gt;    // 指定日志路径</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">3. 配置文件启动</span><br><span class=\"line\">* 在项目根目录添加启动配置文件pm2.config.js&#96;&#96;&#96;js</span><br><span class=\"line\">&#39;use strict&#39;;</span><br><span class=\"line\">module.exports &#x3D; &#123;</span><br><span class=\"line\">  apps: [&#123;</span><br><span class=\"line\">    name: &#39;server&#39;, &#x2F;&#x2F; 项目名</span><br><span class=\"line\">    script: &#39;.&#x2F;server.js&#39;, &#x2F;&#x2F; 执行文件</span><br><span class=\"line\">    cwd: &#39;.&#x2F;&#39;, &#x2F;&#x2F; 根目录</span><br><span class=\"line\">    args: &#39;one two&#39;, &#x2F;&#x2F; 传递给脚本的参数</span><br><span class=\"line\">    interpreter: &#39;&#39;, &#x2F;&#x2F; 指定的脚本解释器</span><br><span class=\"line\">    interpreter_args: &#39;&#39;, &#x2F;&#x2F; 传递给解释器的参数      &#x2F;&#x2F;</span><br><span class=\"line\">    exec_mode: &#39;cluster_mode&#39;, &#x2F;&#x2F; 应用启动模式，支持fork和cluster模式</span><br><span class=\"line\">    instances: 1, &#x2F;&#x2F; 应用启动实例个数，仅在cluster模式有效 默认为fork；或者 max</span><br><span class=\"line\">    max_memory_restart: &#39;1G&#39;, &#x2F;&#x2F; 最大内存限制数，超出自动重启</span><br><span class=\"line\">    error_file: &#96;.&#x2F;logs&#x2F;pm2&#x2F;new Date()&#x2F;app-err.log&#96;, &#x2F;&#x2F; 错误日志文件</span><br><span class=\"line\">    out_file: &#96;.&#x2F;logs&#x2F;pm2&#x2F;new Date()&#x2F;app-out.log&#96;, &#x2F;&#x2F; 正常日志文件</span><br><span class=\"line\">    merge_logs: true, &#x2F;&#x2F; 设置追加日志而不是新建日志</span><br><span class=\"line\">    log_date_format: &#39;YYYY-MM-DD HH:mm:ss&#39;, &#x2F;&#x2F; 指定日志文件的时间格式</span><br><span class=\"line\">    min_uptime: 1000, &#x2F;&#x2F; 应用运行少于时间被认为是异常启动</span><br><span class=\"line\">    max_restarts: 30, &#x2F;&#x2F; 最大异常重启次数，即小于min_uptime运行时间重启次数；</span><br><span class=\"line\">    autorestart: true, &#x2F;&#x2F; 默认为true, 发生异常的情况下自动重启</span><br><span class=\"line\">    cron_restart: &#39;&#39;, &#x2F;&#x2F; crontab时间格式重启应用，目前只支持cluster模式;</span><br><span class=\"line\">    restart_delay: 60, &#x2F;&#x2F; 异常重启情况下，延时重启时间      &#x2F;&#x2F;</span><br><span class=\"line\">    watch: true, &#x2F;&#x2F; 是否监听文件变动然后重启      &#x2F;&#x2F;</span><br><span class=\"line\">    ignore_watch: [ &#x2F;&#x2F;   &#x2F;&#x2F; 不用监听的文件      &#x2F;&#x2F;</span><br><span class=\"line\">      &#39;node_modules&#39;, &#x2F;&#x2F;   &#39;logs&#39;,      &#x2F;&#x2F;</span><br><span class=\"line\">      &#39;news&#39;, &#x2F;&#x2F;</span><br><span class=\"line\">      &#39;run&#39;, &#x2F;&#x2F;</span><br><span class=\"line\">      &#39;test&#39;, &#x2F;&#x2F;</span><br><span class=\"line\">      &#39;typings&#39;, &#x2F;&#x2F;</span><br><span class=\"line\">      &#39;pm2.config&#39;, &#x2F;&#x2F;</span><br><span class=\"line\">    ],</span><br><span class=\"line\">    env: &#123;</span><br><span class=\"line\">      NODE_ENV: &#39;development&#39;,</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    env_production: &#123;</span><br><span class=\"line\">      NODE_ENV: &#39;production&#39;,</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">  &#125;],</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n<ul>\n<li>启动项目<br>\n<code>pm2 start pm2.config.js</code></li>\n</ul>\n<h3 id=\"二.常用命令\">二.常用命令<a title=\"#二.常用命令\" href=\"#二.常用命令\"></a></h3>\n<ol>\n<li>监控流程```<br>\npm2 restart [app_name|id]      // 重启进程<br>\npm2 reload [app_name|id]       // 0秒停机重载进程 (用于 NETWORKED 进程)<br>\npm2 stop [app_name|id]         // 停止进程<br>\npm2 delete [app_name|id]       // 杀死进程<br>\npm2 show [app_name|id]         // 查看进程详情<br>\n// 如果不是指定项目名而是通过 all 可以操作所有进程</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">2. 获取进程列表</span><br><span class=\"line\">列出PM2管理的所有的状态：</span><br><span class=\"line\">&#96;pm2 [list|ls|status]&#96;</span><br><span class=\"line\"></span><br><span class=\"line\">3. 显示日志</span><br><span class=\"line\">* 要实时显示日志：</span><br><span class=\"line\">&#96;pm2 logs&#96;</span><br><span class=\"line\">* 显示旧日志：</span><br><span class=\"line\">&#96;pm2 logs --lines 200&#96;</span><br><span class=\"line\"></span><br><span class=\"line\">4. 基于终端的仪表板</span><br><span class=\"line\">监控每个node进程的cpu和内存使用情况</span><br><span class=\"line\">&#96;pm2 monit&#96;</span><br><span class=\"line\"></span><br><span class=\"line\">5. 监控运行这些进程的机器</span><br><span class=\"line\">监控所有被PM2管理的进程,同时监控运行这些进程的机器的状态，它会自动在指定端口9615启动一个服务，我们可以在浏览器访问http:&#x2F;&#x2F;localhost:9615 查看详细信息。</span><br><span class=\"line\">&#96;pm2 web&#96;</span><br><span class=\"line\"></span><br><span class=\"line\">6. 自动负载均衡&#96;&#96;&#96;js</span><br><span class=\"line\">&#x2F;&#x2F; 开启指定数目的进程&#x2F;机器cpu核数对应的数目的进程运行</span><br><span class=\"line\">pm2 start server.js -i [number|max]</span><br><span class=\"line\">&#x2F;&#x2F; 配置文件里对应的</span><br><span class=\"line\">&quot;instance&quot;: [number|max]</span><br></pre></td></tr></table></figure>\n<h3 id=\"三.监控可视化\">三.监控可视化<a title=\"#三.监控可视化\" href=\"#三.监控可视化\"></a></h3>\n<ol>\n<li>安装pm2-web<br>\n<code>npm install -g pm2-web</code><br>\n默认pm2-web会自动启动一个端口8080</li>\n<li>配置文件启动</li>\n</ol>\n<ul>\n<li>创建配置文件<br>\n<code>pm2-web --config pm2-web-config.json</code></li>\n<li>指定端口```js<br>\n// pm2-web-config.json<br>\n{<br>\n“www”: {<br>\n“host”: “localhost”,<br>\n“address”: “0.0.0.0”,<br>\n“port”: 6688<br>\n}<br>\n}</li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">### 四.在egg框架中使用pm2</span><br><span class=\"line\">1. 在项目根目录定义启动文件：&#96;&#96;&#96;js</span><br><span class=\"line\">&#x2F;&#x2F; server.js</span><br><span class=\"line\">const egg &#x3D; require(&#39;egg&#39;);</span><br><span class=\"line\">const workers &#x3D; Number(process.argv[2] || require(&#39;os&#39;).cpus().length);</span><br><span class=\"line\">egg.startCluster(&#123;</span><br><span class=\"line\">  workers,</span><br><span class=\"line\">  baseDir: __dirname,</span><br><span class=\"line\">&#125;);</span><br></pre></td></tr></table></figure>\n<ol start=\"2\">\n<li>启动<br>\n<code>pm2 start server.js</code></li>\n</ol>\n","prev":{"title":"npm包开发","link":"2020/07/20/npm包开发"},"next":{"title":"powershell美化","link":"2020/07/20/powershell美化"},"plink":"http://qiuxiaori.github.com/2020/07/20/node线上部署pm2篇/","toc":[{"id":"一.安装使用","title":"一.安装使用","index":"1"}],"copyright":{"author":"Qiu Xiaori","license":"自由转载-非商用-禁止演绎-保持署名（CC BY-NC-ND 4.0)","link":"<a href=\"http://qiuxiaori.github.com/2020/07/20/node线上部署pm2篇/\" title=\"node线上部署pm2篇\">http://qiuxiaori.github.com/2020/07/20/node线上部署pm2篇/</a>"}}
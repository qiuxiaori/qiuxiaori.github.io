{"title":"上传文件到金山云","date":"2021-05-21T11:04:50.439Z","date_formatted":{"ll":"May 21, 2021","L":"05/21/2021","MM-DD":"05-21"},"link":"2021/05/21/上传文件到金山云","tags":["Node"],"categories":["编程技术"],"updated":"2021-05-21T11:04:50.440Z","content":"<p><a href=\"https://www.ksyun.com/proservice/storage_service\" target=\"_blank\">金山对象存储</a>（Kingsoft Standard Storage Service，简称KS3是金山云为企业用户提供的无限制、多备份、分布式的低成本存储空间服务，解决存储扩容、数据可靠安全以及分布式访问等相关复杂问题。入门文档见<a href=\"https://docs.ksyun.com/documents/858\" target=\"_blank\">这里</a>。</p>\n<a id=\"more\"></a>\n<h3 id=\"一.使用入门\">一.使用入门<a title=\"#一.使用入门\" href=\"#一.使用入门\"></a></h3>\n<h4 id=\"1.开通ks3服务\">1.开通KS3服务<a title=\"#1.开通ks3服务\" href=\"#1.开通ks3服务\"></a></h4>\n<ol>\n<li>注册金山云账户<br>\n使用KS3对象存储，需要注册金山云账户并开通KS3服务。</li>\n</ol>\n<ul>\n<li>转到 <a href=\"https://passport.ksyun.com/register.html\" target=\"_blank\">https://passport.ksyun.com/register.html</a> 注册页面。</li>\n<li>按照注册认证帮助文档的说明进行操作。</li>\n</ul>\n<ol start=\"2\">\n<li>开通KS3服务</li>\n</ol>\n<ul>\n<li>登录控制台后，点击右上角账号下拉菜单，选择【accesskeys】,进入【AK密钥管理】页面。<br>\n<img src=\"https://resource.ksyun.com/project/cms/fdb82ab59adba76ad27bb785b7cb1fda\" alt=\"1\"></li>\n<li>点击【AK密钥】标签页，检查访问密钥是否正常，如果您还没有创建访问密钥，请立即创建。密钥创建后30分钟即可生效。有关访问密钥的内容请参考<a href=\"https://docs.ksyun.com/documents/1376\" target=\"_blank\">身份与访问控制（IAM）文档</a>。<br>\n<img src=\"https://resource.ksyun.com/project/cms/02e14263e6fd907fde29858760955588\" alt=\"2\"></li>\n</ul>\n<ol start=\"3\">\n<li>联系金山云商务或售前人员为您开通KS3上传、下载权限。<br>\nks3存储功能需要购买，价格清单看👀<a href=\"https://price.ksyun.com/#!/ks3/price\" target=\"_blank\">这里</a>。</li>\n</ol>\n<h4 id=\"2.创建存储空间\">2.创建存储空间<a title=\"#2.创建存储空间\" href=\"#2.创建存储空间\"></a></h4>\n<ol>\n<li>Bucket<br>\n注册开通金山云KS3后，您就可以开始使用KS3管理控制台创建存储空间（Bucket）。KS3中的每个文件（Object）都存储在存储空间(Bucket)中。必须先创建一个存储空间，然后才能在KS3中存储数据。</li>\n<li>存储空间限制<br>\n同一用户创建的存储空间总数不能超过30个。<br>\n存储空间的名称在KS3服务内全局唯一。<br>\n存储空间一旦创建成功，名称和所处地域不能修改。<br>\n单个存储空间的容量无限制。</li>\n<li>操作步骤<br>\n进入 KS3 管理控制台界面 <a href=\"https://ks3.console.ksyun.com/console.html\" target=\"_blank\" rel=\"noopener\">https://ks3.console.ksyun.com/console.html</a> 。<br>\n单击新建空间。<br>\n注意：存储空间的命名必须符合命名规范。所选定的存储空间名称在KS3的所有现有存储空间名称中必须具有唯一性。创建后不支持更改存储空间名称。具体过程见<a href=\"https://docs.ksyun.com/documents/859\" target=\"_blank\">官方文档</a>。</li>\n</ol>\n<h4 id=\"3.文件上传\">3.文件上传<a title=\"#3.文件上传\" href=\"#3.文件上传\"></a></h4>\n<ol>\n<li>\n<p>上传工具上传<br>\n上传工具<a href=\"https://docs.ksyun.com/documents/894\" target=\"_blank\">下载地址</a>及使用方法。</p>\n</li>\n<li>\n<p>api上传<br>\n控制台不能上传超过500M的文件，最多只能255个文件，大文件请通过API进行分块上传:<a href=\"http://ks3.ksyun.com/doc/api/multipart_upload.html\" target=\"_blank\" rel=\"noopener\">http://ks3.ksyun.com/doc/api/multipart_upload.html</a></p>\n</li>\n</ol>\n<h4 id=\"4.文件分享&amp;&amp;删除&amp;&amp;空间删除\">4.文件分享&amp;&amp;删除&amp;&amp;空间删除<a title=\"#4.文件分享&amp;&amp;删除&amp;&amp;空间删除\" href=\"#4.文件分享&amp;&amp;删除&amp;&amp;空间删除\"></a></h4>\n<ol>\n<li>文件分享 <a href=\"https://docs.ksyun.com/documents/861\" target=\"_blank\" rel=\"noopener\">https://docs.ksyun.com/documents/861</a></li>\n<li>文件删除 <a href=\"https://docs.ksyun.com/documents/862\" target=\"_blank\" rel=\"noopener\">https://docs.ksyun.com/documents/862</a></li>\n<li>空间删除 <a href=\"https://docs.ksyun.com/documents/863\" target=\"_blank\" rel=\"noopener\">https://docs.ksyun.com/documents/863</a></li>\n</ol>\n<h3 id=\"二.概念和术语\">二.概念和术语<a title=\"#二.概念和术语\" href=\"#二.概念和术语\"></a></h3>\n<ol>\n<li>\n<p>AccessKey（访问秘钥）、SecretKey<br>\n使用KS3，您需要KS3颁发给您的AccessKey（长度为20个字符的ASCII字符串）和SecretKey（长度为40个字符的ASCII字符串）。AccessKey用于标识客户的身份，SecretKey作为私钥形式存放于客户服务器不在网络中传递。SecretKey通常用作计算请求签名的密钥，用以保证该请求是来自指定的客户。使用AccessKey进行身份识别，加上SecretKey进行数字签名，即可完成应用接入与认证授权。</p>\n</li>\n<li>\n<p>Region（区域）<br>\n地区包含：中国(北京）、中国（上海）、中国（香港）,创建bucket时需要选择Region,如果不配置成对应的域名将返回307，会跳转到Bucket所在的Region。</p>\n</li>\n</ol>\n<div class=\"φcy\"><div class=\"φda\"><table><thead>\n<tr>\n<th>Region中文名称</th>\n<th>外网域名</th>\n<th>内网域名</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>中国（北京）</td>\n<td><a href=\"http://ks3-cn-beijing.ksyun.com\" target=\"_blank\" rel=\"noopener\">ks3-cn-beijing.ksyun.com</a></td>\n<td><a href=\"http://ks3-cn-beijing-internal.ksyun.com\" target=\"_blank\" rel=\"noopener\">ks3-cn-beijing-internal.ksyun.com</a></td>\n</tr>\n<tr>\n<td>中国（上海）</td>\n<td><a href=\"http://ks3-cn-shanghai.ksyun.com\" target=\"_blank\" rel=\"noopener\">ks3-cn-shanghai.ksyun.com</a></td>\n<td><a href=\"http://ks3-cn-shanghai-internal.ksyun.com\" target=\"_blank\" rel=\"noopener\">ks3-cn-shanghai-internal.ksyun.com</a></td>\n</tr>\n<tr>\n<td>中国（香港）</td>\n<td><a href=\"http://ks3-cn-hk-1.ksyun.com\" target=\"_blank\" rel=\"noopener\">ks3-cn-hk-1.ksyun.com</a></td>\n<td><a href=\"http://ks3-cn-hk-1-internal.ksyun.com\" target=\"_blank\" rel=\"noopener\">ks3-cn-hk-1-internal.ksyun.com</a></td>\n</tr>\n</tbody>\n</table></div></div><ol start=\"3\">\n<li>\n<p>Service（服务）<br>\nKS3提供给用户的虚拟存储空间，在这个虚拟空间中，每个用户可拥有一个到多个Bucket。</p>\n</li>\n<li>\n<p>Bucket（存储空间）<br>\nBucket是存放Object的容器，所有的Object都必须存放在特定的Bucket中。每个用户最多可以创建20个Bucket，每个Bucket中可以存放无限多个Object。Bucket不能嵌套，每个Bucket中只能存放Object，不能再存放Bucket，Bucket下的Object是一个平级的结构。Bucket的名称全局唯一且命名规则与DNS命名规则相同：</p>\n</li>\n</ol>\n<ul>\n<li>仅包含小写英文字母（a-z），数字，点（.），中线，即： abcdefghijklmnopqrstuvwxyz0123456789.-</li>\n<li>必须由字母或数字开头</li>\n<li>长度在3和63个字符之间</li>\n<li>不能是IP的形式，类似192.168.0.1</li>\n<li>不能以kss开头</li>\n</ul>\n<ol start=\"5\">\n<li>\n<p>Object（对象，文件）<br>\n在KS3中，用户操作的基本数据单元是Object。单个Object允许存储0~5TB的数据。 Object 包含key和data。其中，key是Object的名字；data是Object 的数据。key为UTF-8编码，且编码后的长度不得超过1024个字节。</p>\n</li>\n<li>\n<p>Key（文件名）<br>\n即Object的名字，key为UTF-8编码，且编码后的长度不得超过1024个字节。Key中可以带有斜杠，当Key中带有斜杠的时候，将会自动在控制台里组织成目录结构。</p>\n</li>\n<li>\n<p>ACL（访问控制权限）<br>\n对Bucket和Object相关访问的控制策略，例如允许匿名用户公开访问等。<br>\n目前ACL支持READ, WRITE, FULL_CONTROL三种权限。对于bucket的拥有者,总是FULL_CONTROL。可以授予所有用户(包括匿名用户)或指定用户READ， WRITE, 或者FULL_CONTROL权限。<br>\n目前提供了三种预设的ACL.分别是private、public-read和public-read-write。public-read表示为所有用户授予READ权限，public-read-write表示为所有用户授予WRITE权限.使用的时候通过在header中添加x-kss-acl实现。<br>\n对于BUCKET来说，READ是指罗列Bucket中的文件、罗列Bucket中正在进行的分块上传、罗列某个分块上传已经上传的块。WRITE是指可以上传，删除BUCKET中文件的功能。FULL_CONTROL则包含所有操作。可以通过PUT Bucket acl接口设置。<br>\n对于Object来说，READ是指查看或者下载文件的功能。WRITE无意义。FULL_CONTROL则包含所有操作。可以通过PUT Object acl设置。</p>\n</li>\n<li>\n<p>Logging（日志）<br>\n对Bucket和Object的日志配置。<br>\n当给Bucket配置Logging之后，每天将会自动把该Bucket的操作日志上传到指定的Bucket。</p>\n</li>\n</ol>\n<h3 id=\"三.ks3-sdk-for-node.js\">三.KS3 SDK For Node.js<a title=\"#三.ks3-sdk-for-node.js\" href=\"#三.ks3-sdk-for-node.js\"></a></h3>\n<p><a href=\"https://ks3.ksyun.com/doc/sdk/nodejs.html#sdk%E8%AF%A6%E7%BB%86%E4%BB%8B%E7%BB%8D\" target=\"_blank\" rel=\"noopener\">https://ks3.ksyun.com/doc/sdk/nodejs.html#sdk详细介绍</a></p>\n<h3 id=\"四.一个小实例\">四.一个小实例<a title=\"#四.一个小实例\" href=\"#四.一个小实例\"></a></h3>\n<ol>\n<li>安装ks3插件<br>\n<code>npm i ks3 --save</code></li>\n<li>引入模块```js<br>\nconst fs = require(‘fs’);<br>\nconst KS3 = require(‘ks3’);</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">3. 具体实现&#96;&#96;&#96;js</span><br><span class=\"line\"></span><br><span class=\"line\">let ks3 &#x3D; new KS3(KS3Config.AK, KS3Config.SK, KS3Config.server, KS3Config.region);</span><br><span class=\"line\"> _ks3upload(file, type) &#123;</span><br><span class=\"line\">    return new Promise(function (resolve, reject) &#123;</span><br><span class=\"line\">        let bucket &#x3D; type;</span><br><span class=\"line\">        let filePath &#x3D; file.path;</span><br><span class=\"line\">        let fileName &#x3D; file.name;</span><br><span class=\"line\">        let suffix &#x3D; (fileName.match(&#x2F;\\.[^.]*$&#x2F;) || [&#39;&#39;])[0];</span><br><span class=\"line\">        let pathname &#x3D; [bucket, uuidV1().replace(&#x2F;-&#x2F;g, &#39;&#39;) + suffix].join(&#39;&#x2F;&#39;);</span><br><span class=\"line\"></span><br><span class=\"line\">        let ksUrl &#x3D; url.format(&#123;</span><br><span class=\"line\">            protocol: KS3Config.protocol,</span><br><span class=\"line\">            hostname: KS3Config.hostname,</span><br><span class=\"line\">            pathname: pathname</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">        ks3.object.put(&#123;</span><br><span class=\"line\">            Key: pathname,</span><br><span class=\"line\">            ACL: &#39;public-read&#39;,</span><br><span class=\"line\">            filePath: filePath</span><br><span class=\"line\">        &#125;, function (error, data, res) &#123;</span><br><span class=\"line\">            &#x2F;&#x2F; 请求错误</span><br><span class=\"line\">            if (error || res.statusCode !&#x3D;&#x3D; 200) &#123;</span><br><span class=\"line\">                reject(error || res.statusCode);</span><br><span class=\"line\">                return;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            &#x2F;&#x2F; 上传成功后删除临时文件</span><br><span class=\"line\">            fs.unlink(filePath, function (err) &#123;</span><br><span class=\"line\">                if (err) Logger.error(err);</span><br><span class=\"line\">            &#125;);</span><br><span class=\"line\">            &#x2F;&#x2F; 检验上传是否成功</span><br><span class=\"line\">            ks3.object.getAcl(&#123;</span><br><span class=\"line\">                Key: pathname</span><br><span class=\"line\">            &#125;, function (error, data, res) &#123;</span><br><span class=\"line\">                &#x2F;&#x2F; 请求错误</span><br><span class=\"line\">                if (error || res.status !&#x3D;&#x3D; 200) &#123;</span><br><span class=\"line\">                    reject(&#39;上传失败请重新上传&#39;);</span><br><span class=\"line\">                    return;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                resolve(ksUrl);</span><br><span class=\"line\">            &#125;);</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">  &#125;</span><br></pre></td></tr></table></figure>\n","prev":{"title":"代码备份","link":"2021/05/21/代码备份"},"next":{"title":"windows包管理器scoop的使用","link":"2021/05/21/windows包管理器scoop的使用"},"plink":"http://qiuxiaori.github.com/2021/05/21/上传文件到金山云/","toc":[{"id":"一.使用入门","title":"一.使用入门","index":"1","children":[{"id":"1.开通ks3服务","title":"1.开通KS3服务","index":"1.1"},{"id":"2.创建存储空间","title":"2.创建存储空间","index":"1.2"},{"id":"3.文件上传","title":"3.文件上传","index":"1.3"},{"id":"4.文件分享&amp;&amp;删除&amp;&amp;空间删除","title":"4.文件分享&amp;&amp;删除&amp;&amp;空间删除","index":"1.4"}]},{"id":"二.概念和术语","title":"二.概念和术语","index":"2"},{"id":"三.ks3-sdk-for-node.js","title":"三.KS3 SDK For Node.js","index":"3"},{"id":"四.一个小实例","title":"四.一个小实例","index":"4"}],"copyright":{"author":"Qiu Xiaori","license":"自由转载-非商用-禁止演绎-保持署名（CC BY-NC-ND 4.0)","link":"<a href=\"http://qiuxiaori.github.com/2021/05/21/上传文件到金山云/\" title=\"上传文件到金山云\">http://qiuxiaori.github.com/2021/05/21/上传文件到金山云/</a>"}}
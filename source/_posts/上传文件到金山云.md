---
title: 上传文件到金山云
tags: Node
categories: 编程技术
---

[金山对象存储](https://www.ksyun.com/proservice/storage_service)（Kingsoft Standard Storage Service，简称KS3是金山云为企业用户提供的无限制、多备份、分布式的低成本存储空间服务，解决存储扩容、数据可靠安全以及分布式访问等相关复杂问题。入门文档见[这里](https://docs.ksyun.com/documents/858)。

<!--more-->
### 一.使用入门

#### 1.开通KS3服务
1. 注册金山云账户
使用KS3对象存储，需要注册金山云账户并开通KS3服务。
* 转到 [https://passport.ksyun.com/register.html](https://passport.ksyun.com/register.html ) 注册页面。
* 按照注册认证帮助文档的说明进行操作。
2. 开通KS3服务
* 登录控制台后，点击右上角账号下拉菜单，选择【accesskeys】,进入【AK密钥管理】页面。
![1](https://resource.ksyun.com/project/cms/fdb82ab59adba76ad27bb785b7cb1fda)
* 点击【AK密钥】标签页，检查访问密钥是否正常，如果您还没有创建访问密钥，请立即创建。密钥创建后30分钟即可生效。有关访问密钥的内容请参考[身份与访问控制（IAM）文档](https://docs.ksyun.com/documents/1376)。
![2](https://resource.ksyun.com/project/cms/02e14263e6fd907fde29858760955588)
3. 联系金山云商务或售前人员为您开通KS3上传、下载权限。
ks3存储功能需要购买，价格清单看👀[这里](https://price.ksyun.com/#!/ks3/price)。

#### 2.创建存储空间
1. Bucket
注册开通金山云KS3后，您就可以开始使用KS3管理控制台创建存储空间（Bucket）。KS3中的每个文件（Object）都存储在存储空间(Bucket)中。必须先创建一个存储空间，然后才能在KS3中存储数据。
2. 存储空间限制
同一用户创建的存储空间总数不能超过30个。
存储空间的名称在KS3服务内全局唯一。
存储空间一旦创建成功，名称和所处地域不能修改。
单个存储空间的容量无限制。
3. 操作步骤
进入 KS3 管理控制台界面 https://ks3.console.ksyun.com/console.html 。
单击新建空间。
注意：存储空间的命名必须符合命名规范。所选定的存储空间名称在KS3的所有现有存储空间名称中必须具有唯一性。创建后不支持更改存储空间名称。具体过程见[官方文档](https://docs.ksyun.com/documents/859)。


#### 3.文件上传
1. 上传工具上传
上传工具[下载地址](https://docs.ksyun.com/documents/894)及使用方法。

2. api上传
控制台不能上传超过500M的文件，最多只能255个文件，大文件请通过API进行分块上传:http://ks3.ksyun.com/doc/api/multipart_upload.html

#### 4.文件分享&&删除&&空间删除
1. 文件分享 https://docs.ksyun.com/documents/861
2. 文件删除 https://docs.ksyun.com/documents/862
3. 空间删除 https://docs.ksyun.com/documents/863

### 二.概念和术语
1. AccessKey（访问秘钥）、SecretKey
使用KS3，您需要KS3颁发给您的AccessKey（长度为20个字符的ASCII字符串）和SecretKey（长度为40个字符的ASCII字符串）。AccessKey用于标识客户的身份，SecretKey作为私钥形式存放于客户服务器不在网络中传递。SecretKey通常用作计算请求签名的密钥，用以保证该请求是来自指定的客户。使用AccessKey进行身份识别，加上SecretKey进行数字签名，即可完成应用接入与认证授权。

2. Region（区域）
地区包含：中国(北京）、中国（上海）、中国（香港）,创建bucket时需要选择Region,如果不配置成对应的域名将返回307，会跳转到Bucket所在的Region。

| Region中文名称 | 外网域名 | 内网域名 |
| --- | --- | --- |
|中国（北京）|ks3-cn-beijing.ksyun.com|ks3-cn-beijing-internal.ksyun.com|
|中国（上海）|ks3-cn-shanghai.ksyun.com|ks3-cn-shanghai-internal.ksyun.com|
|中国（香港）|ks3-cn-hk-1.ksyun.com|ks3-cn-hk-1-internal.ksyun.com|

3. Service（服务）
KS3提供给用户的虚拟存储空间，在这个虚拟空间中，每个用户可拥有一个到多个Bucket。

4. Bucket（存储空间）
Bucket是存放Object的容器，所有的Object都必须存放在特定的Bucket中。每个用户最多可以创建20个Bucket，每个Bucket中可以存放无限多个Object。Bucket不能嵌套，每个Bucket中只能存放Object，不能再存放Bucket，Bucket下的Object是一个平级的结构。Bucket的名称全局唯一且命名规则与DNS命名规则相同：
* 仅包含小写英文字母（a-z），数字，点（.），中线，即： abcdefghijklmnopqrstuvwxyz0123456789.-
* 必须由字母或数字开头
* 长度在3和63个字符之间
* 不能是IP的形式，类似192.168.0.1
* 不能以kss开头

5. Object（对象，文件）
在KS3中，用户操作的基本数据单元是Object。单个Object允许存储0~5TB的数据。 Object 包含key和data。其中，key是Object的名字；data是Object 的数据。key为UTF-8编码，且编码后的长度不得超过1024个字节。

6. Key（文件名）
即Object的名字，key为UTF-8编码，且编码后的长度不得超过1024个字节。Key中可以带有斜杠，当Key中带有斜杠的时候，将会自动在控制台里组织成目录结构。

7. ACL（访问控制权限）
对Bucket和Object相关访问的控制策略，例如允许匿名用户公开访问等。
目前ACL支持READ, WRITE, FULL_CONTROL三种权限。对于bucket的拥有者,总是FULL_CONTROL。可以授予所有用户(包括匿名用户)或指定用户READ， WRITE, 或者FULL_CONTROL权限。
目前提供了三种预设的ACL.分别是private、public-read和public-read-write。public-read表示为所有用户授予READ权限，public-read-write表示为所有用户授予WRITE权限.使用的时候通过在header中添加x-kss-acl实现。
对于BUCKET来说，READ是指罗列Bucket中的文件、罗列Bucket中正在进行的分块上传、罗列某个分块上传已经上传的块。WRITE是指可以上传，删除BUCKET中文件的功能。FULL_CONTROL则包含所有操作。可以通过PUT Bucket acl接口设置。
对于Object来说，READ是指查看或者下载文件的功能。WRITE无意义。FULL_CONTROL则包含所有操作。可以通过PUT Object acl设置。

8. Logging（日志）
对Bucket和Object的日志配置。
当给Bucket配置Logging之后，每天将会自动把该Bucket的操作日志上传到指定的Bucket。

### 三.KS3 SDK For Node.js
https://ks3.ksyun.com/doc/sdk/nodejs.html#sdk%E8%AF%A6%E7%BB%86%E4%BB%8B%E7%BB%8D
### 四.一个小实例
1. 安装ks3插件
`npm i ks3 --save`
2. 引入模块```js
  const fs = require('fs');
  const KS3 = require('ks3');
```

3. 具体实现```js

let ks3 = new KS3(KS3Config.AK, KS3Config.SK, KS3Config.server, KS3Config.region);
 _ks3upload(file, type) {
    return new Promise(function (resolve, reject) {
        let bucket = type;
        let filePath = file.path;
        let fileName = file.name;
        let suffix = (fileName.match(/\.[^.]*$/) || [''])[0];
        let pathname = [bucket, uuidV1().replace(/-/g, '') + suffix].join('/');

        let ksUrl = url.format({
            protocol: KS3Config.protocol,
            hostname: KS3Config.hostname,
            pathname: pathname
        });
        ks3.object.put({
            Key: pathname,
            ACL: 'public-read',
            filePath: filePath
        }, function (error, data, res) {
            // 请求错误
            if (error || res.statusCode !== 200) {
                reject(error || res.statusCode);
                return;
            }
            // 上传成功后删除临时文件
            fs.unlink(filePath, function (err) {
                if (err) Logger.error(err);
            });
            // 检验上传是否成功
            ks3.object.getAcl({
                Key: pathname
            }, function (error, data, res) {
                // 请求错误
                if (error || res.status !== 200) {
                    reject('上传失败请重新上传');
                    return;
                }
                resolve(ksUrl);
            });
        });
    });
  }
```

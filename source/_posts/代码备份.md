---
title: 代码备份
tags: 源码
categories: 编程技术
password: 777521
---
实现的需求整理备份
<!--more-->
### 一.上传文件创建需求
```js
'use strict';
const Service = require('egg').Service;
// 文件模块
const _ = require('lodash');
let stories = [];
const _recursionHtml = (notes, parentName) => {
  notes.map(e => {
    if (e.pageName) {
      const name = parentName + e.pageName;
      stories.push(name);
      // 递归子节点
      if (e.children) {
        _recursionHtml(e.children, name + '/');
      }
    }
  });
};
class StoryService extends Service {
  async addStoryByFile() {
    const { ctx, app } = this;
    // 参数接收,校验
    let stream = '';
    try {
      stream = await ctx.getFileStream();
    } catch (err) {
      return err;
    }
    const session = ctx.session;
    const workspace_id = stream.fields.workspace_id;
    const iteration_id = stream.fields.iteration_id;
    if (!stream || !workspace_id || !iteration_id) {
      return new Error('params error');
    }
    // 时间锁
    if (session.cTime) {
      const sIteration_id = session.sIteration_id || '';
      const isBlocker = (Date.now() - session.cTime) < 7000;
      if (isBlocker && sIteration_id === iteration_id) {
        return {};
      }
    }
    ctx.session.cTime = Date.now();
    ctx.session.sIteration_id = iteration_id;
    // 读取文件代码
    stream.setEncoding('utf-8');
    let data = '';
    stream.on('data', chunk => {
      data += chunk;
    });
    await new Promise((resolve, reject) => {
      stream.on('end', () => { // 监听状态
        resolve();
      });
    });
    // 执行代码方法
    const $axure = {};
    let rootNodes = {};
    $axure.loadDocument = function(d) {
      rootNodes = d.sitemap.rootNodes || '';
    };
    if (!data.match(/axure.loadDocument/)) {
      return new Error('con\'t analysis file');
    }
    try {
      eval(data);
    } catch (err) {
      return err;
    }
    if (rootNodes.length === 0) {
      return new Error('analysis file error');
    } else if (rootNodes.length === 1) {
      if (rootNodes[0].children) {
        _recursionHtml(rootNodes[0].children, '');
      }
    } else {
      _recursionHtml(rootNodes, '');
    }
    // 获取当前要创建的迭代的需求
    const curStories = await app.tapd('stories', {
      data: { workspace_id, iteration_id, limit: 200 },
      method: 'GET',
    });
    // 如果当前迭代已有需求，去重
    if (curStories.status === 1 && curStories.data.lenght !== 0) {
      const curNames = [];
      curStories.data.map(e => {
        const name = e.Story.name || '';
        if (curNames.indexOf(name) === -1) {
          curNames.push(name);
        }
      });
      stories = _.difference(stories, curNames);
    }
    // 创建需求和任务
    const creator = ctx.session.user.real_name || '';
    for (const name of stories) {
      const result = await app.tapd('stories', {
        data: { name, workspace_id, iteration_id, priority: 3, creator },
        method: 'POST',
      });
      if (result.status === 1) {
        const story_id = result.data.Story.id;
        const qName = name + '_前端';
        const taskRes = await app.tapd('tasks', {
          data: { name: qName, workspace_id, iteration_id, priority: 3, creator, story_id },
          method: 'POST',
        });
      }
    }
    return {};
  }
}
module.exports = StoryService;
```


### 二.导出excel浏览器下载
```js
const xlsx = require('node-xlsx');
const moment = require('moment');
/**
 * 导出文章统计数据为xlsx文件
 * @param {*} ctx 
 */
async function exportResource(ctx){
  const req = ctx.request;
  const result = await _getEliteResources(req);// 获取数据,无关方法略
  let rows = result.rows || [];                // 获取数据数组
  // 创建excel二维数组，定义表头
  let retval = [
    ['文章名称', '创建者', '审核者', '创建时间','浏览','收藏','点赞','点击量','点击率','转发次数']
  ]; 
  // 添加订单数据
  for (let row of rows || []) {
      const statistics = row.statistics;
      retval.push([
          row.body.title || '',
          row.creator || '',
          row.last_editor,
          row.ctime,
          statistics.show_count,
          statistics.collection_count,
          statistics.like_count,
          statistics.click_count,
          statistics.view_rate,
          statistics.forward_count,
      ]);
  }
  // 空数据时填充
  retval.push([ '', '', '', '', '', '', '', '', '', '']);
  // 创建数据流
  let buffer = xlsx.build([{
      data: retval
  }]);
  // 设置生成的文件名
  let filename = moment(new Date()).format('YYYY-MM-DD') + '文件名';
  filename = encodeURIComponent(filename);
  let disposition = `attachment;filename=${filename}.xlsx`;
  // 设置响应头
  ctx.response.set({
      'content-type': 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
      'content-disposition': disposition,
      'filename': filename + '.xlsx'
  });
  ctx.body = buffer;
}
```


### 三.使用axios下载网络资源
```
const axios = require('axios');
const GET_RESOURCES_URL = 'http://127.0.0.1:8160/fdp_api/resources';
const PUT_RESOURCE_URL = 'http://127.0.0.1:8160/fdp_api/resources/cover';
const Cookie = 'kbplat-test-session-id=6719da848e0ec864081ea55f28ff77ab197f90829085338f8d5b7871aeae4f974a7b7406c388bc58b9973528d17ea0c1259af9cb32b925a944774bd4d2235fa069af99c24f35ee09e2267f21387028df580b434864df19f10d333afac3dec2bb060fa0666ed539ca2203fac9adcee9bef20dccfb6fb16e0d104fd1a5fa828702cc9d0d1f98f16b0c249bc72bc8c4933e81064a6b57de0fe9fd1075fa7d239e8d140fa093f11ecdd0775e6e07a212a5811bca6a3fee90070bd9d56b38c4aa747d733c80571999188a448e0d6a86af8d9db5c9e172e353b43465d47d05dbfc927e32ef46c812b0feb503db58e4dbf5c2feb497f27f6b2cbba755ccb21b25d258bc39089cb7c358df368e8c2db00cff57cdc72b30c94316a4a69ebeb27f9871394835584b168ed55b41bcc7c6a85518cfba0a9a7435979e88dac0ad3d93b32af50412efcd6483adb7ccbfad0c3e4b2cdea809a070d91454aef7e4d2ea295d646ddd475ce1f6580d0ade71271308882ae2daf57a1b9603e4a640131b524f28017e6e5ef38b9c15ea4ef185b91865c645a4333d50090a36c38a6d589bf3ab70779aee6787b1ea97a4ccc537b2bb3f327ceb8d6ad7d35fc435fe680c3c8aba087b90e0';

(async function updateCovers(){
  let resources = [];
  await new Promise((resolve, reject) => {
    axios({ 
      headers: { 'Cookie': Cookie },
      method: 'get', 
      url: GET_RESOURCES_URL, 
      params: { elite: 1, type: '视频', limit: 760}
    }).then(response => {
      resources = response.data.data.rows;
      resolve();
    }).catch(err => {
      throw err;
      reject();
    });

  })
  for(let i = 7; i < 8; i++){
    const response = await axios({ 
      method: 'put', 
      headers: { 'Cookie': Cookie },
      url: PUT_RESOURCE_URL, 
      data: resources[i]
    });
  }
})();
```